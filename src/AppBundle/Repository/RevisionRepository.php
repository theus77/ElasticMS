<?php

namespace AppBundle\Repository;

use AppBundle\Entity\Revision;
use AppBundle\Entity\Environment;

/**
 * RevisionRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class RevisionRepository extends \Doctrine\ORM\EntityRepository
{
	
	public function draftCounterGroupedByContentType() {

		$qb = $this->createQueryBuilder('r');
		$qb->select('c.id content_type_id', 'count(c.id) counter');
		$qb->join('r.contentType', 'c');
		$and = $qb->expr()->andX();
		$and->add($qb->expr()->eq('r.deleted', 0));
		$and->add($qb->expr()->eq('r.draft', true));
		$qb->where($and);
		$qb->groupBy('c.id');
		
		return $qb->getQuery()->getResult();
	}


	public function findByOuuidContentTypeAndEnvironnement(Revision $revision) {
	
		$qb = $this->createQueryBuilder('r');
		$qb->join('r.environments', 'e');
		$qb->where('r.ouuid = :ouuid and e.id = :envId and r.contentType = :contentTypeId');
		$qb->setParameters([
				'ouuid' => $revision->getOuuid(),
				'envId' => $revision->getContentType()->getEnvironment()->getId(),
				'contentTypeId' => $revision->getContentType()->getId()
		]);
	
		return $qb->getQuery()->getResult();
	}
}
